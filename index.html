<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>njob</title>
    <link rel="icon" type="image/png" href="njob.png">
    <link rel="apple-touch-icon" href="njob.png">
    <link rel="manifest" href='data:application/manifest+json,{"name":"njob","short_name":"njob","start_url":".","display":"standalone","background_color":"#000000","theme_color":"#000000"}'>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMdnd3kjfS9rZJodhNclNPffa1Vn2DV5I&libraries=geometry,directions"></script>

    <style>
        :root { --bg: #000; --card: #1e293b; --blue: #1a73e8; --green: #1ed760; --red: #d93025; --gold: #fbc02d; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; position: relative; }
        
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #splash img { width: 180px; height: auto; margin-bottom: 50px; border-radius: 20px; }
        .btn-start { background: transparent; color: var(--blue); border: 3px solid var(--blue); padding: 20px 80px; border-radius: 50px; font-size: 1.8rem; font-weight: 900; cursor: pointer; }

        .btn-side { position: absolute; right: 15px; width: 44px; height: 44px; border: 2px solid white; border-radius: 50%; font-size: 24px; font-weight: bold; display: none; align-items: center; justify-content: center; z-index: 1000; cursor: pointer; }
        #exit-btn { top: 15px; background: var(--red); }
        #mute-btn { top: 70px; background: var(--blue); }

        .nav-label { font-size: 0.8rem; color: var(--blue); font-weight: 900; margin: 3px 0; text-transform: uppercase; }
        .nav-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 6px; flex-shrink: 0; margin-right: 60px; scroll-behavior: smooth; }
        .nav-row::-webkit-scrollbar { display: none; }
        .btn-s { background: var(--card); color: #fff; border: 1px solid #444; padding: 10px 14px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; min-width: 75px; white-space: nowrap; }
        .btn-s.active { background: var(--blue); color: white; border-color: white; box-shadow: 0 0 12px var(--blue); }

        .display { background: var(--card); border: 2px solid #334155; border-radius: 20px; padding: 12px; text-align: center; margin-bottom: 8px; flex-shrink: 0; overflow: hidden; }
        #stop-name-container { width: 100%; display: flex; justify-content: center; align-items: center; white-space: nowrap; height: 60px; }
        #stop-name { color: var(--blue); font-weight: 900; margin: 0; line-height: 1.1; letter-spacing: -1px; display: inline-block; }

        #timer-row { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 5px 0; }
        #timer { font-size: 3.4rem; font-weight: 900; color: var(--green); }
        #eta-container { display: flex; flex-direction: column; align-items: center; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 10px; border: 1px solid #444; }
        #eta-timer { font-size: 1.8rem; font-weight: 900; color: var(--blue); }
        .eta-label { font-size: 0.65rem; color: #aaa; text-transform: uppercase; margin-bottom: 2px; font-weight: 900; }

        #gps-msg { font-weight: bold; font-size: 0.9rem; height: 1.2rem; margin-top: 5px; text-align: center; }

        #speed-panel { background: rgba(30, 41, 59, 0.9); border: 1px solid var(--gold); border-radius: 12px; display: flex; align-items: center; justify-content: center; height: 50px; margin-bottom: 8px; }
        #speed-val { font-size: 1.8rem; font-weight: 900; color: var(--gold); }
        
        #map-container { position: relative; flex: 1; width: 100%; margin-bottom: 12px; border: 2px solid #334155; border-radius: 15px; overflow: hidden; }
        #map { width: 100%; height: 100%; } 

        /* OKIENKO MANEWRÃ“W - PRZYWRÃ“CONE 70% PRZEZROCZYSTOÅšCI */
        #nav-overlay { 
            position: absolute; top: 8px; left: 8px; z-index: 50;
            background: rgba(255, 255, 255, 0.3); border-radius: 8px; padding: 6px 10px; 
            min-width: 60px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #nav-icon-svg { width: 32px; height: 32px; fill: var(--blue); }
        #nav-dist { font-size: 0.9rem; font-weight: 900; color: #222; margin-top: 2px; }

        .footer { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; height: 65px; margin-bottom: 85px; flex-shrink: 0; }
        .btn-nav { background: var(--card); color: var(--blue); border: 2px solid var(--blue); border-radius: 12px; font-size: 1.1rem; font-weight: bold; text-transform: uppercase; transition: 0.3s; }
        .btn-nav:active { background: var(--blue); color: black; }
        .btn-finish { background: var(--red) !important; color: white !important; border-color: white !important; box-shadow: 0 0 15px var(--red); }
    </style>
</head>
<body onclick="forceFullScreen()">

    <div id="splash">
        <img src="njob.png" alt="njob">
        <button class="btn-start" onclick="startApp()">START</button>
    </div>

    <button id="exit-btn" class="btn-side" onclick="exitApp()">Ã—</button>
    <button id="mute-btn" class="btn-side" onclick="toggleMute()">ðŸ”ˆ</button>

    <div class="nav-label">ðŸ”µ WYJAZDY:</div>
    <div id="work-bar" class="nav-row"></div>
    <div class="nav-label">ðŸ”µ POWROTY:</div>
    <div id="return-bar" class="nav-row"></div>

    <div class="display">
        <div id="stop-name-container">
            <div id="stop-name">CZEKAJ...</div>
        </div>
        <div id="timer-row">
            <div id="timer">--</div>
            <div id="eta-container">
                <span class="eta-label">Dojedziesz za</span>
                <div id="eta-timer">--</div>
            </div>
        </div>
        <div id="gps-msg"></div>
    </div>

    <div id="speed-panel"><span id="speed-val">0</span><span style="font-size:0.6rem; color:#aaa; margin-left:5px;">km/h</span></div>

    <div id="map-container">
        <div id="nav-overlay">
            <svg id="nav-icon-svg" viewBox="0 0 24 24"><path d=""/></svg>
            <div id="nav-dist">--- m</div>
        </div>
        <div id="map"></div>
    </div>

    <div class="footer">
        <button class="btn-nav" onclick="move(-1)">Poprzedni</button>
        <button id="next-btn" class="btn-nav" onclick="handleStep()">NastÄ™pny</button>
    </div>

<script>
    const locNK = { "n": "NOWE KRAMSKO", "la": 52.140361, "ln": 15.770278 };
    const locMOD = { "n": "MODIVO", "la": 51.915056, "ln": 15.628250 };
    const locCRS = { "n": "ZJAZD: PARKING CRS", "la": 51.956111, "ln": 15.528250 };
    const locZawada = { lat: 51.990056, lng: 15.562667 };

    const njobW = [locNK, locMOD];
    const njobR = [locMOD, locNK];

    var schedules = {
        "04:55": njobW.map((s,i) => ({...s, t: i===0 ? "04:55" : "---"})),
        "09:05": njobW.map((s,i) => ({...s, t: i===0 ? "09:05" : "---"})),
        "13:05": njobW.map((s,i) => ({...s, t: i===0 ? "13:05" : "---"})),
        "14:15": njobR.map((s,i) => ({...s, t: i===0 ? "14:15" : "---"})),
        "22:15": njobR.map((s,i) => ({...s, t: i===0 ? "22:15" : "---"}))
    };

    var labels = { "04:55": "4:55", "09:05": "9:05", "13:05": "13:05", "14:15": "14:15", "22:15": "22:15" };
    var curr = "04:55", idx = 0, map, ds, dr, userPos, liveDelay = 0, userMarker, wakeLock = null, isMuted = false, currentNextManeuverLoc = null, lastApiCall = 0, catchupDone = false, currentKmh = 0, specialTarget = null, isFirstCalc = true, lastTap = 0, currentSummary = "", lastManeuverDist = 999999;

    const iconPaths = { 
        "straight": "M11,6.5V21H13V6.5L16.5,10L17.92,8.58L12,2.66L6.08,8.58L7.5,10L11,6.5Z", 
        "turn-right": "M17,11.5L17,5L15,5L15,10L7,10L7,8L3,12L7,16L7,14L15,14C16.1,14 17,13.1 17,12V11.5Z", 
        "turn-left": "M7,11.5L7,5L9,5L9,10L17,10L17,8L21,12L17,16L17,14L9,14C7.9,14 7,13.1 7,12V11.5Z", 
        "roundabout": "M12,2C10.12,2 8.36,2.6 6.9,3.61L8.5,5.21C9.5,4.45 10.7,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,10.7 4.45,9.5 5.21,8.5L3.61,6.9C2.6,8.36 2,10.12 2,12C2,17.5 6.5,22 12,22C17.5,22 22,17.5 22,12C22,6.5 17.5,2 12,2M12,7L7,12H11V16H13V12H17L12,7Z",
        "roundabout-right": "M12,2C6.5,2 2,6.5 2,12S6.5,22 12,22 22,17.5 22,12 17.5,2 12,2M12,20C7.6,20 4,16.4 4,12S7.6,4 12,4 20,7.6 20,12 16.4,20 12,20M13,11H17V7L19,10L17,13V9H13V11M11,18V13H13V18H11Z",
        "roundabout-left": "M12,2C6.5,2 2,6.5 2,12S6.5,22 12,22 22,17.5 22,12 17.5,2 12,2M12,20C7.6,20 4,16.4 4,12S7.6,4 12,4 20,7.6 20,12 16.4,20 12,20M11,11H7V7L5,10L7,13V9H11V11M13,18V13H11V18H13Z",
        "roundabout-straight": "M12,2C6.5,2 2,6.5 2,12S6.5,22 12,22 22,17.5 22,12 17.5,2 12,2M12,20C7.6,20 4,16.4 4,12S7.6,4 12,4 20,7.6 20,12 16.4,20 12,20M11,9V5L12,2L13,5V9H11M11,18V13H13V18H11Z",
        "fork-right": "M15,7L13.59,8.41L15.17,10H12C10.34,10 9,11.34 9,13V21H11V13C11,12.45 11.45,12 12,12H15.17L13.59,13.59L15,15L19,11L15,7Z",
        "fork-left": "M9,7L13,11L9,15L7.59,13.59L9.17,12H6C5.45,12 5,12.45 5,13V21H3V13C3,11.34 4.34,10 6,10H9.17L7.59,8.41L9,7Z",
        "uturn": "M14.5,14C16.43,14 18,12.43 18,10.5S16.43,7 14.5,7H6V4L2,8L6,12V9H14.5C15.33,9 16,9.67 16,10.5S15.33,12 14.5,12H6V14H14.5Z"
    };

    function forceFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); }
    async function requestWakeLock() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }

    function adjustFontSize() {
        const container = document.getElementById('stop-name-container');
        const text = document.getElementById('stop-name');
        let fontSize = 40; text.style.fontSize = fontSize + "px";
        while (text.offsetWidth < container.offsetWidth - 20 && fontSize < 60) { fontSize++; text.style.fontSize = fontSize + "px"; }
        while (text.offsetWidth > container.offsetWidth - 10 && fontSize > 10) { fontSize--; text.style.fontSize = fontSize + "px"; }
    }

    function startApp() {
        if(typeof google === 'undefined') { alert("BÅ‚Ä…d Map!"); return; }
        autoSelectKurs(); requestWakeLock();
        document.getElementById('splash').style.display = 'none';
        document.getElementById('exit-btn').style.display = 'flex';
        document.getElementById('mute-btn').style.display = 'flex';
        document.getElementById('nav-overlay').style.display = 'flex';
        renderNav(); setTimeout(() => { scrollBarsToUpcoming(); adjustFontSize(); }, 400); 
        initMap(); initGPS();
        setInterval(calc, 60000); setInterval(refresh, 1000);
    }

    function initGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                userPos = { lat: p.coords.latitude, lng: p.coords.longitude };
                currentKmh = (p.coords.speed && p.coords.speed > 0) ? Math.round(p.coords.speed * 3.6) : 0;
                document.getElementById('speed-val').innerText = currentKmh;
                if (map) { 
                    map.panTo(userPos);
                    if (p.coords.heading !== null) map.setHeading(p.coords.heading);
                    map.setTilt(45);
                    const navArrow = { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale: 6, fillColor: "#1a73e8", fillOpacity: 1, strokeColor: "white", strokeWeight: 2, rotation: p.coords.heading || 0 };
                    if (!userMarker) userMarker = new google.maps.Marker({ position: userPos, map: map, icon: navArrow, flat: true });
                    else { userMarker.setPosition(userPos); userMarker.setIcon(navArrow); }
                }
                if (currentNextManeuverLoc) {
                    let d = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userPos.lat, userPos.lng), currentNextManeuverLoc);
                    document.getElementById('nav-dist').innerText = d > 1000 ? (d/1000).toFixed(1) + " km" : Math.round(d) + " m";
                    if ((d < 25 || (d > lastManeuverDist && lastManeuverDist < 40)) && (Date.now() - lastApiCall > 7000)) calc();
                    lastManeuverDist = d;
                }
                if (isFirstCalc) { calc(); isFirstCalc = false; }
                checkAutoArrival();
            }, null, { enableHighAccuracy: true });
        }
    }

    function openFullGoogleMaps() {
        if (!userPos) return;
        let dest = specialTarget ? specialTarget.la + "," + specialTarget.ln : schedules[curr][idx].la + "," + schedules[curr][idx].ln;
        let url = `https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${dest}&travelmode=driving`;
        window.open(url, "_blank");
    }

    function checkAutoArrival() { if(!userPos) return; let target = specialTarget ? specialTarget : schedules[curr][idx]; let d = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userPos.lat, userPos.lng), new google.maps.LatLng(target.la, target.ln)); if (d < 75) { if (specialTarget) { specialTarget = null; autoSelectKurs(); renderNav(); calc(); refresh(); } else if (idx < schedules[curr].length - 1) { idx++; calc(); refresh(); } else { triggerNextKurs(); } } }
    function triggerNextKurs() { if (curr === "13:05") { curr = "14:15"; idx = 0; specialTarget = null; } else { specialTarget = locCRS; } renderNav(); calc(); refresh(); scrollBarsToUpcoming(); }

    function initMap() {
        const navStyle = [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }];
        map = new google.maps.Map(document.getElementById("map"), { 
            center: {lat: 51.91, lng: 15.62}, 
            zoom: 19, tilt: 45, heading: 0, mapId: '404d56c3d3985c59c43ef386',
            disableDefaultUI: true, styles: navStyle, disableDoubleClickZoom: true
        });
        map.addListener('dblclick', openFullGoogleMaps);
        new google.maps.TrafficLayer().setMap(map);
        ds = new google.maps.DirectionsService(); dr = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, preserveViewport: true });
    }

    function calc() {
        if(!userPos || !ds) return;
        lastApiCall = Date.now();
        let destination = specialTarget ? {lat: specialTarget.la, lng: specialTarget.ln} : {lat: schedules[curr][idx].la, lng: schedules[curr][idx].ln};
        let wps = [];
        if (specialTarget) { wps.push({ location: new google.maps.LatLng(locZawada.lat, locZawada.lng), stopover: false }); }
        ds.route({ origin: userPos, destination: destination, waypoints: wps, travelMode: google.maps.TravelMode.DRIVING }, (res, stat) => {
            if(stat === 'OK') { 
                dr.setDirections(res); 
                currentSummary = res.routes[0].summary;
                liveDelay = Math.round((res.routes[0].legs[0].duration.value / 60) * 1.15);
                const step = res.routes[0].legs[0].steps[0];
                currentNextManeuverLoc = step.end_location; lastManeuverDist = 999999;
                
                // SKANOWANIE MANEWRU I TEKSTU
                const rawMan = (step.maneuver || "").toLowerCase();
                const instr = (step.instructions || "").toLowerCase();
                let path = iconPaths["straight"];
                
                if (rawMan.includes("roundabout") || instr.includes("rondo")) {
                    if (instr.includes("lewo") || instr.includes("left") || instr.includes("3. zjazd")) path = iconPaths["roundabout-left"];
                    else if (instr.includes("prawo") || instr.includes("right") || instr.includes("1. zjazd")) path = iconPaths["roundabout-right"];
                    else if (instr.includes("prosto") || instr.includes("2. zjazd")) path = iconPaths["roundabout-straight"];
                    else path = iconPaths["roundabout"];
                } else if (rawMan.includes("uturn") || instr.includes("zawrÃ³Ä‡")) {
                    path = iconPaths["uturn"];
                } else if (rawMan.includes("fork") || rawMan.includes("ramp") || rawMan.includes("merge") || instr.includes("zjedÅº") || instr.includes("wÅ‚Ä…cz")) {
                    path = (rawMan.includes("left") || instr.includes("lewo")) ? iconPaths["fork-left"] : iconPaths["fork-right"];
                } else if (rawMan.includes("left") || instr.includes("lewo")) {
                    path = iconPaths["turn-left"];
                } else if (rawMan.includes("right") || instr.includes("prawo")) {
                    path = iconPaths["turn-right"];
                }
                document.getElementById('nav-icon-svg').querySelector('path').setAttribute('d', path);
            }
        });
    }

    function refresh() {
        let s = specialTarget ? specialTarget : schedules[curr][idx];
        const stopNameEl = document.getElementById('stop-name');
        const nextBtn = document.getElementById('next-btn');
        const gpsMsgEl = document.getElementById('gps-msg');
        const timePart = (s.t && s.t !== "---") ? "(" + s.t + ") " : "";
        const newStopText = timePart + s.n;
        if (stopNameEl.innerText !== newStopText) { stopNameEl.innerText = newStopText; adjustFontSize(); }
        if (specialTarget) { nextBtn.innerText = "ZAKOÅƒCZ"; nextBtn.classList.add('btn-finish'); } else { nextBtn.innerText = "NASTÄ˜PNY"; nextBtn.classList.remove('btn-finish'); }
        
        let tEl = document.getElementById('timer'); let etaEl = document.getElementById('eta-timer');
        etaEl.innerText = liveDelay > 0 ? liveDelay + "m" : "--";
        
        if(!s.t || s.t === "---") {
            let n = new Date(); n.setMinutes(n.getMinutes() + liveDelay);
            tEl.innerText = n.getHours() + ":" + (n.getMinutes()<10?'0':'') + n.getMinutes();
            tEl.style.color = "var(--blue)";
            gpsMsgEl.innerText = "";
        } else {
            let p = s.t.split(':'); let tr = new Date(); tr.setHours(p[0], p[1], 0);
            let diff = Math.ceil((tr - new Date()) / 60000); if (diff < -90) diff += 1440;
            tEl.innerText = diff < 60 ? diff + " min" : Math.floor(diff/60)+"h "+(diff%60)+"m";
            tEl.style.color = (diff < 0) ? "var(--red)" : "var(--green)";
            
            const delta = diff - liveDelay;
            let statusText = (delta >= 0) ? "ZAPAS CZASU: " + delta + " min" : "SPÃ“Å¹NIENIE: " + Math.abs(delta) + " min";
            gpsMsgEl.style.color = (delta >= 0) ? "var(--gold)" : "var(--red)";
            gpsMsgEl.innerText = statusText;
        }
    }

    function scrollBarsToUpcoming() { const rows = [document.getElementById('work-bar'), document.getElementById('return-bar')]; rows.forEach(row => { const act = row.querySelector('.active'); if(act) row.scrollTo({left: act.offsetLeft - 20, behavior: 'smooth'}); }); }
    function renderNav() { let w = document.getElementById('work-bar'); let r = document.getElementById('return-bar'); w.innerHTML = ""; r.innerHTML = ""; for(let k in schedules) { let b = document.createElement('button'); b.className = 'btn-s' + (k === curr ? ' active' : ''); b.innerText = labels[k] || k; b.onclick = (e) => { e.stopPropagation(); curr = k; idx = 0; specialTarget = null; renderNav(); calc(); }; if (["14:15", "22:15"].includes(k)) r.appendChild(b); else w.appendChild(b); } }
    function toggleMute() { isMuted = !isMuted; document.getElementById('mute-btn').innerText = isMuted ? "ðŸ”‡" : "ðŸ”ˆ"; }
    function exitApp() { if(confirm("ZakoÅ„czyÄ‡?")) location.reload(); }
    function move(d) { if(schedules[curr] && schedules[curr][idx + d]) { idx += d; specialTarget = null; calc(); } }
    function handleStep() { if (specialTarget) { specialTarget = null; autoSelectKurs(); renderNav(); calc(); } else if (idx >= (schedules[curr]?.length || 0) - 1) triggerNextKurs(); else { idx++; calc(); } }
    function autoSelectKurs() { const now = new Date(); const minNow = now.getHours() * 60 + now.getMinutes(); const keys = Object.keys(labels).sort(); let selected = keys[0]; for (let k of keys) { const [h, m] = k.split(':').map(Number); if (minNow < (h * 60 + m) + 90) { selected = k; break; } } curr = selected; }
</script>
</body>
</html>