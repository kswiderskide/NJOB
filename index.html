<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>KRAMSKO-MODIVO</title>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDEq-AGhrBol0dkthbxNiH9MwSY-BMrD9s&libraries=geometry,directions"></script>

    <style>
        :root { --bg: #000; --card: #1e293b; --blue: #38bdf8; --green: #22c55e; --red: #ef4444; --gold: #fbbf24; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; transition: background-color 0.1s; }
        
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #splash h1 { color: var(--blue); font-size: 2.2rem; font-weight: 900; margin-bottom: 5px; letter-spacing: 3px; text-shadow: 0 0 15px rgba(56,189,248,0.6); }
        #splash p { color: var(--gold); font-weight: bold; margin-bottom: 50px; font-size: 0.9rem; letter-spacing: 1px; }
        .btn-start { background: transparent; color: var(--blue); border: 3px solid var(--blue); padding: 20px 80px; border-radius: 50px; font-size: 1.6rem; font-weight: 900; box-shadow: 0 0 20px rgba(56, 189, 248, 0.4), inset 0 0 15px rgba(56, 189, 248, 0.2); cursor: pointer; transition: 0.3s; }

        .bright-flash { background-color: rgba(255, 255, 255, 0.9) !important; }

        .nav-label { font-size: 1.1rem; color: var(--blue); font-weight: 900; margin: 8px 0 4px 0; text-transform: uppercase; letter-spacing: 1px; }
        .nav-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; flex-shrink: 0; min-height: 50px; }
        .btn-s { background: var(--card); color: #fff; border: 1px solid #444; padding: 12px 18px; border-radius: 10px; font-weight: bold; font-size: 1rem; min-width: 90px; }
        .btn-s.active { background: var(--blue); color: black; border-color: white; box-shadow: 0 0 10px var(--blue); }

        .display { background: var(--card); border: 2px solid #334155; border-radius: 20px; padding: 15px; text-align: center; margin-bottom: 8px; flex-shrink: 0; position: relative; }
        #stop-name { color: var(--blue); font-size: 1.4rem; font-weight: 900; margin: 0; text-transform: uppercase; }
        .timer-container { display: flex; justify-content: center; align-items: baseline; gap: 15px; margin: 5px 0; }
        #timer { font-size: 3.5rem; font-weight: 900; color: var(--green); white-space: nowrap; }
        .gps-sub { font-size: 1.6rem; font-weight: 900; color: var(--blue); opacity: 0.9; }

        #gps-msg { color: var(--gold); font-weight: bold; font-size: 1.1rem; }
        #map { flex: 1; width: 100%; border-radius: 15px; background: #111; margin-bottom: 8px; border: 2px solid var(--blue); }
        .footer { display: flex; gap: 10px; height: 75px; margin-bottom: 5px; flex-shrink: 0; }
        .btn-nav { flex: 1; background: var(--card); color: white; border: 1px solid #444; border-radius: 15px; font-size: 1.2rem; font-weight: bold; }
        button:active { opacity: 0.7; }
    </style>
</head>
<body>

    <div id="splash">
        <h1>KRAMSKO-MODIVO</h1>
        <p>SYSTEM NAWIGACJI</p>
        <button class="btn-start" onclick="startApp()">START</button>
    </div>

    <div class="nav-label">ðŸ”µ WYJAZDY:</div>
    <div class="nav-row" id="work-bar"></div>
    <div class="nav-label">ðŸ”µ POWROTY:</div>
    <div class="nav-row" id="return-bar"></div>

    <div class="display">
        <div id="stop-name">WYBIERZ KURS</div>
        <div class="timer-container">
            <div id="timer">--</div>
            <div class="gps-sub" id="gps-timer">--</div>
        </div>
        <div id="gps-msg">GPS: Oczekiwanie...</div>
    </div>

    <div id="map"></div>

    <div class="footer">
        <button class="btn-nav" onclick="move(-1)">POPRZEDNI</button>
        <button class="btn-nav" id="btn-next" onclick="handleStep()" style="color:var(--blue); border-color:var(--blue);">NASTÄ˜PNY</button>
    </div>

<script>
    var schedules = {
        "04:55": [ { "n": "NOWE KRAMSKO", "t": "04:55", "la": 52.140333, "ln": 15.770250 }, { "n": "MODIVO - EOBUWIE", "t": "---", "la": 51.916250, "ln": 15.626250 } ],
        "09:05": [ { "n": "NOWE KRAMSKO", "t": "09:05", "la": 52.140333, "ln": 15.770250 }, { "n": "MODIVO - EOBUWIE", "t": "---", "la": 51.916250, "ln": 15.626250 } ],
        "13:05": [ { "n": "NOWE KRAMSKO", "t": "13:05", "la": 52.140333, "ln": 15.770250 }, { "n": "MODIVO - EOBUWIE", "t": "---", "la": 51.916250, "ln": 15.626250 } ],
        "14:15": [ { "n": "MODIVO - EOBUWIE", "t": "14:15", "la": 51.916250, "ln": 15.626250 }, { "n": "NOWE KRAMSKO", "t": "---", "la": 52.140333, "ln": 15.770250 } ],
        "22:15": [ { "n": "MODIVO - EOBUWIE", "t": "22:15", "la": 51.916250, "ln": 15.626250 }, { "n": "NOWE KRAMSKO", "t": "---", "la": 52.140333, "ln": 15.770250 } ]
    };

    var curr = "04:55", idx = 0, map, ds, dr, userPos, liveDelay = 0;
    var lastAlertPoint = "", lastAlertTime = 0, alarmRepetitionCount = 0;
    var lastSirenTime = 0;

    function startApp() {
        var doc = document.documentElement;
        if (doc.requestFullscreen) doc.requestFullscreen();
        else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
        
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        
        document.getElementById('splash').style.opacity = '0';
        setTimeout(() => { document.getElementById('splash').style.display = 'none'; }, 500);
        
        renderNav(); refresh(); initMap(); initGPS(); setInterval(refresh, 1000);
    }

    function formatClock(totalMin) {
        if (totalMin < 0) return totalMin + " min";
        if (totalMin < 60) return totalMin + " min";
        let h = Math.floor(totalMin / 60);
        let m = totalMin % 60;
        return h + "h " + (m < 10 ? "0" + m : m) + "m";
    }

    function triggerPips(volume) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        function pip(time) {
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination); o.frequency.value = 950;
            g.gain.setValueAtTime(0, time);
            g.gain.linearRampToValueAtTime(volume, time + 0.01);
            g.gain.exponentialRampToValueAtTime(0.001, time + 0.12);
            o.start(time); o.stop(time + 0.15);
            setTimeout(() => {
                document.body.classList.add('bright-flash');
                setTimeout(() => document.body.classList.remove('bright-flash'), 80);
            }, (time - ctx.currentTime) * 1000);
        }
        pip(ctx.currentTime); pip(ctx.currentTime + 0.25); pip(ctx.currentTime + 0.50);
    }

    function triggerSiren() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(400, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(900, ctx.currentTime + 0.3);
        osc.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.6);
        g.gain.setValueAtTime(0, ctx.currentTime);
        g.gain.linearRampToValueAtTime(0.5, ctx.currentTime + 0.1);
        g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.7);
        osc.start(); osc.stop(ctx.currentTime + 0.7);
        for(let i=0; i<6; i++) {
            setTimeout(() => {
                document.body.classList.add('bright-flash');
                setTimeout(() => document.body.classList.remove('bright-flash'), 50);
            }, i * 120);
        }
    }

    function initGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                userPos = { lat: p.coords.latitude, lng: p.coords.longitude };
                document.getElementById('gps-msg').innerText = "GPS: PoÅ‚Ä…czono";
                checkAutoArrival(); calc();
            }, null, { enableHighAccuracy: true });
        }
    }

    function initMap() {
        if(typeof google === 'undefined') return;
        map = new google.maps.Map(document.getElementById("map"), { center: {lat: 52.00, lng: 15.70}, zoom: 12, mapTypeId: 'satellite', disableDefaultUI: true });
        map.addListener("click", function() {
            var s = schedules[curr][idx];
            window.open("https://www.google.com/maps/dir/?api=1&destination=" + s.la + "," + s.ln + "&travelmode=driving", "_blank");
        });
        ds = new google.maps.DirectionsService(); dr = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
    }

    function checkAutoArrival() {
        if(!userPos || typeof google === 'undefined') return;
        let t = schedules[curr][idx];
        let d = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userPos.lat, userPos.lng), new google.maps.LatLng(t.la, t.ln));
        if (d < 60) {
            if (idx === 0) { idx = 1; refresh(); calc(); }
            else if (curr === "13:05" && idx === 1) { curr = "14:15"; idx = 0; renderNav(); refresh(); calc(); }
        }
    }

    function calc() {
        if(!userPos || !ds) return;
        ds.route({ origin: userPos, destination: {lat: schedules[curr][idx].la, lng: schedules[curr][idx].ln}, travelMode: 'DRIVING' }, (res, stat) => {
            if(stat === 'OK') { dr.setDirections(res); liveDelay = Math.round(res.routes[0].legs[0].duration.value / 60); }
        });
    }

    function refresh() {
        let s = schedules[curr][idx];
        document.getElementById('stop-name').innerText = s.n;
        let tEl = document.getElementById('timer');
        let gtEl = document.getElementById('gps-timer');
        gtEl.innerText = formatClock(liveDelay);
        document.getElementById('btn-next').innerText = (idx >= 1) ? "ZAKOÅƒCZ âœ…" : "NASTÄ˜PNY";

        if(s.t === "---") {
            let n = new Date(); n.setMinutes(n.getMinutes() + liveDelay);
            tEl.innerText = n.getHours() + ":" + (n.getMinutes()<10?'0':'') + n.getMinutes();
            tEl.style.color = "var(--blue)"; gtEl.style.display = "none";
        } else {
            gtEl.style.display = "block";
            let p = s.t.split(':'); let tr = new Date(); tr.setHours(p[0], p[1], 0);
            let diff = Math.ceil((tr - new Date()) / 60000);
            if (diff < -90) diff += 1440;
            tEl.innerText = formatClock(diff);
            tEl.style.color = (diff < 0) ? "var(--red)" : "var(--green)";
            let zap = diff - liveDelay;
            document.getElementById('gps-msg').innerText = "ZAPAS: " + formatClock(zap);
            
            let alertID = curr + "_" + idx;
            let now = Date.now();
            if (userPos) {
                if (zap === 1 && (now - lastSirenTime > 60000)) {
                    triggerSiren(); lastSirenTime = now;
                } else if (zap <= 5 && zap > 1 && (now - lastAlertTime >= 60000)) {
                    if (lastAlertPoint !== alertID) alarmRepetitionCount = 0;
                    else alarmRepetitionCount++;
                    let vol = Math.min(0.2 + (alarmRepetitionCount * 0.2), 1.0);
                    triggerPips(vol); lastAlertPoint = alertID; lastAlertTime = now;
                }
            }
        }
    }

    function handleStep() {
        if (idx >= 1) {
            if (curr === "13:05") { curr = "14:15"; idx = 0; renderNav(); refresh(); calc(); }
            else if(confirm("ZakoÅ„czyÄ‡ kurs?")) location.reload();
        } else { idx = 1; refresh(); calc(); }
    }

    function move(d) { if(schedules[curr][idx + d]) { idx += d; refresh(); calc(); } }

    function renderNav() {
        let w = document.getElementById('work-bar'); let r = document.getElementById('return-bar');
        w.innerHTML = ""; r.innerHTML = "";
        for(let k in schedules) {
            let b = document.createElement('button'); b.className = 'btn-s' + (k === curr ? ' active' : '');
            b.innerText = k; b.onclick = () => { curr=k; idx=0; renderNav(); refresh(); calc(); };
            if(k === "14:15" || k === "22:15") r.appendChild(b); else w.appendChild(b);
        }
    }
</script>
</body>
</html>